# Data Model: New Quiz Play Flow

**Feature**: 003-new-quiz-play  
**Date**: 2025-01-20

## Entities

### QuizAttempt

Represents a student's session taking a quiz. Created when student starts a quiz, updated as answers are saved, completed when quiz is submitted.

**Fields**:
- `id`: UUID (primary key, auto-generated by backend)
- `quiz`: UUID (foreign key to NewQuiz, required)
- `quiz_title`: String (denormalized for display, from quiz)
- `student`: Integer (foreign key to User, required, current student)
- `student_name`: String (denormalized for display, from user)
- `status`: Enum (`in_progress`, `completed`, `expired`) - Current state of attempt
- `started_at`: DateTime (when attempt was started, required)
- `completed_at`: DateTime (when attempt was completed, nullable)
- `time_spent_seconds`: Integer (total time spent, calculated)
- `time_remaining_seconds`: Integer (remaining time for timed quizzes, nullable)
- `total_score`: Decimal (points earned so far, calculated from saved answers)
- `max_score`: Decimal (maximum possible score, from quiz)
- `score`: Decimal (percentage score, calculated: total_score / max_score * 100)
- `correct_answers`: Integer (count of correct answers, calculated)
- `total_questions`: Integer (total questions in quiz, from quiz)
- `has_pending_essays`: Boolean (whether essay questions need teacher grading)
- `answers`: Array<SavedAnswer> (all saved answers for this attempt)

**State Transitions**:
1. `in_progress` → `completed`: When student submits quiz
2. `in_progress` → `expired`: When time limit expires (auto-transition by backend)
3. `expired` → (no further transitions, attempt is final)

**Validation Rules**:
- Attempt can only be created for published quizzes
- Student must not exceed retake limit
- Attempt belongs to current student (enforced by backend)
- Cannot modify attempt after `completed` or `expired` status

**Relationships**:
- Belongs to: NewQuiz (quiz)
- Belongs to: User (student)
- Has many: SavedAnswer (answers)

---

### SavedAnswer

Represents a student's answer to a single question within a quiz attempt. Created/updated when student saves an answer.

**Fields**:
- `id`: UUID (primary key, auto-generated by backend)
- `attempt`: UUID (foreign key to QuizAttempt, required)
- `question`: UUID (foreign key to NewQuizQuestion, required)
- `question_prompt`: String (denormalized for display, from question)
- `question_type`: Enum (`multiple_choice`, `text_input`, `essay`) - Type of question
- `selected_option`: UUID (foreign key to NewQuizOption, nullable, for MCQ only)
- `selected_option_text`: String (denormalized option text, nullable, for MCQ only)
- `text_answer`: String (student's text answer, nullable, for text-input/essay)
- `attachment_url`: String (URL to uploaded file, nullable, for essay only)
- `is_correct`: Boolean (whether answer is correct, nullable for essay)
- `correct_answer`: Object (correct answer info, nullable for essay)
  - For MCQ: `{ label: String, text: String }`
  - For text-input: `{ text: String }`
  - For essay: `null` (no correct answer, requires teacher grading)
- `auto_graded`: Boolean (whether answer was auto-graded, false for essay)
- `answered_at`: DateTime (when answer was saved, required)

**Validation Rules**:
- For `multiple_choice`: Must have `selected_option`, no `text_answer` or `attachment_url`
- For `text_input`: Must have `text_answer`, no `selected_option` or `attachment_url`
- For `essay`: Must have `text_answer` or `attachment_url` (or both), no `selected_option`
- Answer belongs to attempt (enforced by backend)
- Cannot modify answer after attempt is `completed` or `expired`

**Relationships**:
- Belongs to: QuizAttempt (attempt)
- Belongs to: NewQuizQuestion (question)
- Belongs to: NewQuizOption (selected_option, for MCQ only)

**Auto-Grading Behavior**:
- `multiple_choice`: Auto-graded immediately, `is_correct` set based on option's `is_correct` flag
- `text_input`: Auto-graded immediately, `is_correct` set based on exact text match with sample answer
- `essay`: Not auto-graded, `is_correct` is `false` until teacher grades, `auto_graded` is `false`

---

### NewQuizQuestion

Represents a question within a quiz. Referenced by SavedAnswer.

**Fields** (from existing NewQuiz model):
- `id`: UUID (primary key)
- `quiz`: UUID (foreign key to NewQuiz)
- `question_type`: Enum (`multiple_choice`, `text_input`, `essay`)
- `prompt`: String (question text)
- `explanation`: String (optional, shown after submission)
- `media`: URL (optional, attachment URL)
- `order`: Integer (display order)
- `score`: Decimal (points for this question)
- `options`: Array<NewQuizOption> (for MCQ only)
- `sample_answer`: NewQuizSampleAnswer (for text-input only)

**Note**: This entity is part of the existing NewQuiz model, not created by this feature. It's included here for reference.

---

### QuizResults

Represents the final outcome after quiz submission. Computed from attempt data, not a separate entity.

**Fields** (computed from QuizAttempt after submission):
- `total_score`: Decimal (points earned)
- `max_score`: Decimal (maximum possible points)
- `percentage`: Decimal (score percentage: total_score / max_score * 100)
- `correct_answers`: Integer (number of correct answers)
- `total_questions`: Integer (total questions in quiz)
- `formatted`: String (human-readable format, e.g., "25.0/30.0 (83.3%)")
- `has_pending_essays`: Boolean (whether essay questions need grading)
- `attempt`: QuizAttempt (full attempt data with all answers)

**Note**: This is a computed/dervied entity, returned by the submit endpoint. Not stored separately.

---

## API Data Flow

### Start Attempt Flow

1. **Request**: `POST /api/v1/new_quiz/attempts/start/` with `{ quiz_id: UUID }`
2. **Backend**: Creates QuizAttempt with `status: "in_progress"`, calculates `time_remaining_seconds` if timed
3. **Response**: Returns QuizAttempt with empty `answers` array

### Save Answer Flow

1. **Request**: `POST /api/v1/new_quiz/attempts/{id}/save-answer/` with answer data
2. **Backend**: 
   - Creates or updates SavedAnswer
   - Auto-grades if MCQ or text-input
   - Updates QuizAttempt `total_score` and `correct_answers`
   - Returns SavedAnswer with `is_correct` and `correct_answer`
3. **Response**: Returns SavedAnswer with grading results

### Retrieve Attempt Flow

1. **Request**: `GET /api/v1/new_quiz/attempts/{id}/`
2. **Backend**: Returns QuizAttempt with all SavedAnswer objects in `answers` array
3. **Response**: Full attempt state for session resume

### Submit Attempt Flow

1. **Request**: `POST /api/v1/new_quiz/attempts/{id}/submit/` with empty body
2. **Backend**:
   - Recalculates final scores from all SavedAnswer objects
   - Sets QuizAttempt `status: "completed"`
   - Sets `completed_at` timestamp
   - Calculates final `score` percentage
3. **Response**: Returns QuizAttempt with `status: "completed"` and QuizResults object

---

## Validation Rules Summary

### QuizAttempt
- Cannot start if retake limit exceeded
- Cannot start if quiz not published
- Cannot modify after `completed` or `expired`
- Timer expires automatically (backend handles)

### SavedAnswer
- Question type determines required fields
- Cannot save after attempt `completed` or `expired`
- Cannot save if time expired (backend enforces)
- Auto-grading only for MCQ and text-input

---

## State Management (Frontend)

### Quiz Play Page State

```typescript
{
  attempt: QuizAttempt | null,
  currentQuestionIndex: number,
  answers: Record<questionId, answerData>, // Local state for UI
  timeRemaining: number | null,
  saving: Record<questionId, boolean>, // Track saving status
  saveErrors: Record<questionId, Error>, // Track save errors
  submitting: boolean
}
```

**Note**: `answers` in local state is for UI reactivity. Server is source of truth. On page load, restore from `attempt.answers` array.

